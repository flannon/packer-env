#!/bin/bash -eux

echo "Running puppet install script"

# PUPPET and PUPPEt_VERSION variables should be set inside of Packer's template:
#
# Values for PUPPET can be:
#   'true'          -- build a box with the Puppet
#   'false'         -- build a box without installing Puppet
#
# Values for PUPPET_VERSION can be:
#   'x.y.z'           -- build a box with version x.y.z of Chef
#   'latest'          -- build a box with the latest version
#
# Set PUPPET_VERSION to 'latest' if unset because it can be problematic
# to set variables in pairs with Packer (and Packer does not support
# multi-value variables).
PUPPET=true
PUPPET_VERSION=${PUPPET_VERSION:-latest}

#
#  install.
#

install_puppet()
{
    echo "==> Installing Puppet"
    REDHAT_MAJOR_VERSION=$(egrep -Eo 'release ([0-9][0-9.]*)' /etc/redhat-release | cut -f2 -d' ' | cut -f1 -d.)

    echo "==> Installing Puppet Labs repositories"
    rpm -ipv "http://yum.puppetlabs.com/puppetlabs-release-pc1-el-${REDHAT_MAJOR_VERSION}.noarch.rpm"

    if [[ ${PUPPET_VERSION:-} == 'latest' ]]; then
        echo "==> Installing latest Puppet version"
        yum -y install puppetserver
    else
        echo "==> Installing Puppet version ${PUPPET_VERSION}"
        yum -y install "puppetserver-${PUPPET_VERSION}"
    fi
}

#
# Main script
#

case "${PUPPET}" in
  'true')
    install_puppet
    ;;

  *)
    echo "==> Building box without baking puppet in."
    ;;
esac
