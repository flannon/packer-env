{
  "_comment": "Build with `packer build centos7-1602-ami.json`",
  "builders": [{
    "type": "amazon-ebs",
    "region": "us-east-1",
    "source_ami": "ami-6d1c2007",
    "instance_type": "t2.micro",
    "ssh_username": "centos",
    "ami_name": "{{ user `role` }} centos-7-1602 {{ timestamp }}",
    "ami_description": "{{ user `role` }} Centos 7 1602",
    "ami_virtualization_type": "hvm",
    "security_group_id": "sg-e27fb486",
    "launch_block_device_mappings": [{
      "device_name": "/dev/sda1",
      "volume_size": 8,
      "volume_type": "gp2",
      "delete_on_termination": true
    },
    {
      "device_name": "/dev/sdb",
      "volume_size": 8,
      "volume_type": "gp2",
      "delete_on_termination": true
    }],
    "tags": {
      "Name": "{{ user `role` }}-AMI",
      "OS_Version": "Centos 7",
      "Release": "Latest"
    },
    "ssh_pty": true
  }],

  "provisioners": [
  {
    "type": "shell",
    "inline": [ "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init...'; sleep 1; done" ],
    "inline": [ "sudo bash -c \"sed -s 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config\"" ],
    "inline": [ "sudo bash -c \"yum install -y wget git\"" ]
  },
  {
    "type": "shell",
    "environment_vars": [
      "EC2_USER={{ user `ec2_user` }}",
      "PUPPET_REPO={{ user `puppet_repo` }}",
      "ROLE={{ user `role` }}"
      ],

    "scripts": [
      "scripts/cloudinit.sh",
      "scripts/puppet.sh"
    ]
  },
  {
    "type": "shell",
    "inline": [ "sudo bash -c \"yum -y update\"" ]
  }],

  "variables": {
    "compression_level": "6",
    "cpus": "1",
    "disk_size": "65536",
    "headless": "",
    "iso_checksum": "f90e4d28fa377669b2db16cbcb451fcb9a89d2460e3645993e30e137ac37d284",
    "iso_checksum_type": "sha256",
    "iso_name": "CentOS-7-x86_64-Minimal-1511.iso",
    "kickstart": "anaconda-ks7.cfg",
    "manifest_file": "puppet/environments/development/manifests/default.pp",
    "memory": "512",
    "mirror": "http://mirrors.kernel.org/centos",
    "puppet_repo": "puppetlabs-release-pc1-el-7",
    "role": "uqbar",
    "ssh_timeout": "60m",
    "ssh_username": "vagrant",
    "ssh_password": "vagrant",
    "ec2_username": "centos",
    "version": "0.1.0",
    "virtualbox_guest_os_type": "RedHat_64",
    "vm_name": "centos-7-1602"
  }
}
