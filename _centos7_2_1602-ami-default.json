{
  "_comment": "Build with `packer build centos7-1602-ami.json`",
  "builders": [{
    "type": "amazon-ebs",
    "region": "us-east-1",
    "source_ami": "ami-6d1c2007",
    "instance_type": "t2.micro",
    "ssh_username": "centos",
    "ami_name": "{{ user `role` }} {{ user `os_version` }} {{ user `os_maj_num` }}.{{ user `os_min_num` }}.{{ user `os_release` }} {{ isotime | clean_ami_name }}",
    "ami_description": "{{ user `role` }} Centos 7 1602",
    "ami_virtualization_type": "hvm",
    "security_group_id": "sg-e27fb486",
    "launch_block_device_mappings": [{
      "device_name": "/dev/sda1",
      "volume_size": 8,
      "volume_type": "gp2",
      "delete_on_termination": true
    },
    {
      "device_name": "/dev/sdb",
      "volume_size": 8,
      "volume_type": "gp2",
      "delete_on_termination": true
    }],
    "tags": {
      "Name": "{{ user `role` }} {{ user `os_version` }} {{ user `os_maj_num` }}.{{ user `os_min_num` }}.{{ user `os_release` }} AMI",
      "OS_Version": "{{ user `os_version` }}",
      "Release": "{{ user `os_release` }}"
    },
    "ssh_pty": true
  }],

  "provisioners": [
  {
    "type": "shell",
    "inline": [ "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init...'; sleep 1; done" ],
    "inline": [ "sudo bash -c \"yum install -y wget git\"" ]
  },
  {
    "type": "shell",
    "environment_vars": [
      "EC2_USER={{ user `ec2_username` }}",
      "PUPPET_REPO={{ user `puppet_repo` }}"
      ],
    "execute_command": "echo {{ user `ec2_username` }} | {{ .Vars }} sudo -E -S bash '{{ .Path }}'",
    "scripts": [
      "scripts/cloudinit.sh",
      "scripts/locale.sh",
      "scripts/puppet.sh"
    ]
  },
  {
    "type": "puppet-masterless",
    "execute_command": "if [ ! -z \"{{user `manifest_file` }}\" ]; then echo {{ user `ec2_username` }} | sudo -S -E {{ .FacterVars }} PATH=$PATH:/opt/puppetlabs/bin /opt/puppetlabs/bin/puppet apply --verbose --detailed-exitcodes --modulepath='{{ .ModulePath }}' {{ .ManifestFile }}; fi",
    "facter" : { 
      "fqdn" : "{{ user `vm_name` }}" 
    },  
    "manifest_file": "{{ user `manifest_file` }}",
    "module_paths": [
      "puppet/environments/development/modules/local",
      "puppet/environments/development/modules/sites",
      "puppet/environments/development/modules/thirdparty"
      ],  
      "prevent_sudo": true,
      "ignore_exit_codes": true
  },  
  {
    "type": "shell",
    "inline": [ "sudo bash -c \"yum -y update\"" ],
    "inline": [ "sudo bash -c \"/usr/bin/sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config\"" ]
  },
  {
    "type": "file",
    "source": "src/puppet.tar.gz",
    "destination": "/tmp/puppet.tar.gz"
  },
  {
    "type": "shell",
    "environment_vars": [
      "EC2_USER={{ user `ec2_username` }}"
      ],
    "execute_command": "echo {{ user `ec2_username` }} | {{ .Vars }} sudo -E -S bash '{{ .Path }}'",
    "scripts": [
      "scripts/puppet-load.sh",
      "scripts/cleanup.sh",
      "scripts/rc.local.sh"
    ]
  }],

  "variables": {
    "role": "Default",
    "manifest_file": "puppet/environments/development/manifests/default.pp",
    "compression_level": "6",
    "cpus": "1",
    "disk_size": "65536",
    "headless": "",
    "iso_checksum": "f90e4d28fa377669b2db16cbcb451fcb9a89d2460e3645993e30e137ac37d284",
    "iso_checksum_type": "sha256",
    "iso_name": "CentOS-7-x86_64-Minimal-1511.iso",
    "kickstart": "anaconda-ks7.cfg",
    "memory": "512",
    "mirror": "http://mirrors.kernel.org/centos",
    "os_version": "CentOS",
    "os_maj_num": "7",
    "os_min_num": "2",
    "os_release": "1602",
    "puppet_repo": "puppetlabs-release-pc1-el-7",
    "ssh_timeout": "60m",
    "ssh_username": "vagrant",
    "ssh_password": "vagrant",
    "ec2_username": "centos",
    "version": "0.1.0",
    "virtualbox_guest_os_type": "RedHat_64",
    "vm_name": "centos-7-1602"
  }
}
